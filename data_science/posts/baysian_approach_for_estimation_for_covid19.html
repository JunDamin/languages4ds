<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.548">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2021-09-25">

<title>Practical Recipes for Data Science - COVID-19 백신 효과 측정을 위한 베이지안 접근</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/siamese-cat.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VSE5PGYZWW"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-VSE5PGYZWW', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Practical Recipes for Data Science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="dropdown-header">
 <span class="menu-text">about.qmdx</span></li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JunDamin"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">COVID-19 백신 효과 측정을 위한 베이지안 접근</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">python</div>
                <div class="quarto-category">bayesian</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">vaccine efficacy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 25, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="질문의-시작-백신의-성능은-어떻게-측정한-걸까" class="level2">
<h2 class="anchored" data-anchor-id="질문의-시작-백신의-성능은-어떻게-측정한-걸까">질문의 시작: 백신의 성능은 어떻게 측정한 걸까?</h2>
<p>towardsdatascience의 한 <a href="https://towardsdatascience.com/a-bayesian-model-for-estimating-the-effects-of-covid-19-vaccines-7e9cec99266b">포스트</a>를 보았습니다. 베이지안 모델링을 백신 모델링에 사용한 글인데 이 글을 보고 백신의 효능을 측정하는데 있어 어떻게 통계 모델을 구성 하게 되는지 따라해 보면서 간단하게 정리해 보고자 합니다.</p>
<section id="상대-위험과-백신-효과" class="level3">
<h3 class="anchored" data-anchor-id="상대-위험과-백신-효과">상대 위험과 백신 효과</h3>
<p>뉴스에서 나오는 백신의 예방효과를 보통 퍼센트로 나타내곤 합니다. 화이자 백신은 95%이고, 아스트라제네카는 70%대의 예방률이 나온다고 하는 등 퍼센트로 예방효과를 설명하고 있는데요. 이 숫자들의 의미는 무엇일까요?</p>
<p>단순하게 생각해 보면 화이자 백신을 맞으면 95% 확률로 코로나에 걸리지 않는 것으로 해석하기 쉬운데요. 대략적으로는 맞다고 할 수 있지만 엄밀하게 보면 틀린 해석입니다.</p>
<p>좀 더 정확한 표현은 백신을 맞지 않은 사람보다 백신 맞은 사람이 코로나에 걸릴 확률이 95% 적다는 뜻입니다. 분모에 들어가는 기준이 되는 값이 백신을 맞지 않은 사람이 코로나에 걸릴 확률 인 것입니다. 즉 백신을 맞지 않은 사람 대비 백신을 맞은 사람의 코로나에 걸릴 확률이 백신의 예방효과에서 말하는 퍼센트의 의미입니다.</p>
<p>수식으로 정리를 해보자면 아래와 같습니다.</p>
<p><span class="math display">\[\text{Vaccine efficacy} = 100 \cdot (1 - IRR)\]</span> <span class="math display">\[IRR = \frac{\text{vaccine incidence rate}}{\text{placebo incidence rate}}\]</span></p>
<p>IRR(Incidence Rate Ratio)는 백신 접종자와 미접종자 간 코로나에 감염된 확률의 비율입니다.</p>
<p>따라서 95% 비율로 코로나 감여 확률이 줄어 들었다고 이야기는 백신을 맞은 사람들은 맞지 않은 사람들보다 95% 코로나에 덜 걸렸다는 뜻입니다.</p>
<p>일반적으로 신약을 출시할 때 글로벌 스탠다드는 무작위 대조 실험(RCT)를 진행해야 합니다. 일반적으로는 논문이 출간 된 다음에야 결과를 알 수 있는데, 2020년 당시에는 뉴스에서 간단하게 결과가 공개되어 확인할 수 있었습니다.</p>
</section>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<p>기사에서 발표된 내용은 아래와 같이 간단하게 정리할 수 있습니다.</p>
<ul>
<li><p>화이자(Pfizer): 43,000 참가 2회분 접종(백신 또는 위약). 통제집단과 실험 집단의 크기는 동일 An efficacy of 95%는 among 170 확진자 중 8명이 백신 접종을 한 집단에서 나왔음을 의미</p></li>
<li><p>모더나(Moderna): 30,000명 대상으로 실험 진행. 절반은 2회 백신 접종, 나머지 절반은 2회 위약 접종을 하였으며 95명의 확진자 중 90명이 위약 그룹에서 발생</p></li>
<li><p>아스트라제네카 1번 요법(AstraZeneca regimen 1): 첫번째 요법(0.5회분 접종 후 한달 뒤 1회분 접종)을 맞은 2741명이 90% efficacy를 보였다고 한다는 건 확진자 37명 중 3명은 접종 그룹임을 의미.(실험군과 대조군의 크기가 같다고 가정)</p></li>
<li><p>아스트라제네카 2번 요법(AstraZeneca regimen 2): 두번째 요법(한 달 간격으로 1회분씩 접종)을 실시한 8896참가자에게서 62% efficacy를 달성했다는 건 94명의 확진자 중, 26명이 백신 그룹에서 나왔음을 의미.(실험군과 대조군의 크기가 같다고 가정)</p></li>
</ul>
</section>
<section id="베이지안-모델" class="level2">
<h2 class="anchored" data-anchor-id="베이지안-모델">베이지안 모델</h2>
<p>아주 간단한 모델을 만들어서 백신의 효능을 추정해 보려고 합니다.(실제 논문에서 다뤄지는 모델은 이보다 훨씬 복잡하긴 할 것입니다. 다만, 그 원리나 방법은 큰 차이는 없습니다.)</p>
<p>우리가 구하고 싶은 백식의 효능을 구하기 위해서 먼저 데이터에서 두집단의 코로나에 걸릴 상대위험을 계산하고자 합니다.</p>
<p>이런 계산을 밑바닥부터 계산할 수도 있겠지만, 이미 개발 된 오픈소스 패키지를 사용하고자 하며, 그 중에서 파이썬에서 많이 사용되는 pymc3를 활용해서 베이지안 모델을 만들어 보고자 합니다.</p>
<p>베이지안 모델을 만들기 위해서는 일단 파라미터화 부터 시작해야 합니다. 모델을 어떻게 만들지 수식에 사용되는 각 항을 파라미터로 만들어서 컴퓨터를 통해 계산할 수 있도록 모델을 작성하고자 합니다.</p>
<section id="베이즈-정리를-통한-수식-전개" class="level3">
<h3 class="anchored" data-anchor-id="베이즈-정리를-통한-수식-전개">베이즈 정리를 통한 수식 전개</h3>
<p>그러기 위해서 먼저 수식을 베이즈 정리를 사용해서 전개해보고자 합니다.</p>
<p><span class="math display">\[  
\begin{align}
\text{Efficacy} &amp;= 1 - \frac{P(positive|treatment)}{P(positive|control)} \\
              &amp;= 1 - \frac{ P(treatment|positive) \cdot P(positive) / P(treatment) } {P(control|positive) \cdot P(positive) / P(control)} \\
              &amp;= 1 - \frac{P(treatment|positive) }{P(control|positive) } \cdot \frac{P(control)} {P(treatment)}
\end{align}
\]</span></p>
<ul>
<li><span class="math inline">\(P(positive|treatment)\)</span>: 백신을 맞은(treatment) 사람이 양성일 확률</li>
<li><span class="math inline">\(P(positive|control)\)</span>: 백신을 맞지 않은(control) 사람이 양성일 확률</li>
<li><span class="math inline">\(P(treatment|positive)\)</span>: 양성인 사람이 백신을 맞았을 확률</li>
<li><span class="math inline">\(P(control|positive)\)</span>: 양성인 사람이 백신을 맞지 않았을 확률</li>
<li><span class="math inline">\(P(control)\)</span>: 어떤 사람이 백신을 맞지 않았을 확률</li>
<li><span class="math inline">\(P(treatment)\)</span>: 어떤 사람이 백신을 맞았을 확률</li>
<li><span class="math inline">\(P(positive)\)</span>: 양성일 확률</li>
</ul>
<p>이렇게 수식을 변경하는 이유는 베이즈 정리를 통해서 직접 측정할 수 없는 것(백신을 맞은 사람이 코로나에 걸릴 확률)을 측정할 수 있는 것(코로나에 걸린 사람이 백신에 맞았을 확률)로 바꿀 수 있기 때문입니다. 즉, 양성이 사람들이 어느 그룹에 속하는지만 알게 되면 우리는 백신의 효능을 측정할 수 있게 수식을 전개 할 수 있는 것입니다.</p>
<p><span class="math inline">\(P(treatment|positive) = 1- p(control|positive)\)</span>임을 이용하면 우리는 단순히 <span class="math inline">\(P(treatment|positive)\)</span>의 분포만을 확인하면 되는 것이고 이는 양성 환자의 수만이 의미가 있다고 볼 수 있습니다.</p>
</section>
<section id="데이터와-연결하기" class="level3">
<h3 class="anchored" data-anchor-id="데이터와-연결하기">데이터와 연결하기</h3>
<p>이렇게 모델(수식)을 만들고 나서는 데이터와 연결을 시켜야 합니다.</p>
<p>likelihood(우도)를 계산한다고 하는데 양성일 확률이 p로 주어졌을 때 주어진 데이터의 결과가 나올 확률을 구하는 것입니다.</p>
<p>pymc3에서는 observed 라는 키워드를 통해서 이를 구현할 수 있습니다.</p>
<p>우선 필요한 패키지를 불러와서 설정을 합니다. pymc3는 모델링, matplotlib과 arivz는 시각화를 위해 필요하며 numpy는 데이터를 생성하기 위해 사용했습니다.</p>
<div id="1b3c9e5d" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc3 <span class="im">as</span> pm</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"fivethirtyeight"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>우선 기사에서 나온 정보를 컴퓨터가 이해하기 좋은 형태로 가공했는데요. 즉 170명 중 8명이 백신 그룹에서 나온 사실을 이용해서 8개의 1과 162개의 0로 이루어진 array(배열)을 만들었습니다.</p>
<div id="74f9285e" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">170</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_treat <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>n_control <span class="op">=</span> n <span class="op">-</span> n_treat</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>treatment_data <span class="op">=</span> np.concatenate([np.ones(n_treat), np.zeros(n_control)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="모델링-양성-환자가-백신을-맞은-그룹에-속한-확률-p" class="level3">
<h3 class="anchored" data-anchor-id="모델링-양성-환자가-백신을-맞은-그룹에-속한-확률-p">모델링: 양성 환자가 백신을 맞은 그룹에 속한 확률 p</h3>
<p>양성 환자가 백신을 맞은 그룹에 속할 확률을 p라고 하자. 그렇게 p를 정했다고 가정하면 우리는 그 p값 하에서 우리가 가진 양성환자 데이터가 나올 확률(likelihood)를 계산할 수 있습니다. 백신에 대해서는 아는 것이 없기도 하고 모든 값이 가능하다고 생각하기 때문에 0과 1사이에 편향이 없는(uniform) 분포와 동일한 Beta(1, 1) 분포를 사전분포(prior distribution)으로 가정했습니다.</p>
<div id="db2487d4" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> pm.Beta(<span class="st">"P(treatment | positive)"</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>)  <span class="co"># p의 분포</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    likelihood <span class="op">=</span> pm.Bernoulli(<span class="st">"likelihood"</span>, p<span class="op">=</span>rate, observed<span class="op">=</span>treatment_data) <span class="co"># p^8*(1-p)^162</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    efficacy <span class="op">=</span> pm.Deterministic(<span class="st">"vaccine efficacy"</span>, <span class="dv">1</span><span class="op">-</span>rate<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>rate))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>pm.model_to_graphviz(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>위 그래프를 조금 해석해 보려고 합니다.</p>
<p><span class="math inline">\(P(treatment | positive)\)</span>는 양성일 때 treatment 그룹에 속할 확률입니다. likelihood가 회색인 이유는 <span class="math inline">\(P(treatment | positive)\)</span>의 값이 정해졌을 때 데이터가 확인될 확률을 베르누이 분포로 구한 것이기 때문입니다.</p>
<p>즉 아래 수식의 값을 구하는 것입니다. 여기서는 170명 중 8명이 백신 맞은 집단이기 때문에 아래와 같은 수식이 되는데요. p는 위에서 언급한 <span class="math inline">\(P(treatment | positive)\)</span>와 같습니다. <span class="math display">\[likelihood = p^{8}(1-p)^{162} \]</span></p>
<p>이렇게 0과 1사이에 있는 p의 분포를 구할 수 있게 됩니다. 사전분포(Prior distribution)과 우도(likelihood)를 구할 수 있으면 우리는 베이즈 정리를 통해 사후분포(posterior distribution)를 얻을 수 잇게 됩니다. 그 p의 사후분포를 통해서 efficacy를 구하게 되는 것입니다.</p>
<p>이제 이를 계산하는 여러가지 방법이 있겠지만, 계산의 현실성 문제 등으로 인해서 MCMC(Markov Chain Monte Carlo) 방법으로 계산을 해보겠습니다.</p>
<p>사후분포를 구하기 위해서는 아래와 같은 코드를 실행 시키면 됩니다.</p>
<div id="06768392" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    trace <span class="op">=</span> pm.sample(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        draws<span class="op">=</span><span class="dv">5000</span>, <span class="co"># sample 5000개를 뽑는다.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        step<span class="op">=</span>pm.HamiltonianMC(), <span class="co"># MCMC의 알고리즘중 HMC방식으로 진행</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>pm.find_MAP(),  <span class="co"># maximum posterior에서 시작</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        progressbar<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이렇게 구해진 p의 사후분포(기존의 지식에서 데이터를 포함해서 구한 분포)를 시각화 하면 아래와 같이 나온다.</p>
<div id="403d253c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    az.plot_trace(trace)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    pm.plot_posterior(trace, var_names<span class="op">=</span>[<span class="st">"vaccine efficacy"</span>])</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>위와 같이 0.91~0.98 사이에 있을 확률이 94%가 되고 평균은 0.94임으로 약 95%로 볼 수 있습니다.</p>
<p>이렇게 뉴스에서 말하는 95% 예방 효과는 사실 91%에서 98% 사이에 대부분 속한다는 의미에 가깝습니다.</p>
</section>
<section id="개의-회사의-발표된-내용을-사용해보자" class="level3">
<h3 class="anchored" data-anchor-id="개의-회사의-발표된-내용을-사용해보자">4개의 회사의 발표된 내용을 사용해보자</h3>
<p>4개의 회사의 자료를 작업해야 하는데 똑같은 행위를 반복하기 때문에 함수를 만들어 계산해 보았습니다.</p>
<div id="ef463217" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_efficacy_model(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    treatment_data, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    rate_name<span class="op">=</span><span class="st">"P(treatment | positive)"</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    likelihood_name<span class="op">=</span><span class="st">"likelihood"</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    efficacy_name<span class="op">=</span><span class="st">"vaccine efficacy"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    beta<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    n_placebo<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    n_vaccine<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>pm.Model()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> model:</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> pm.Beta(rate_name, alpha<span class="op">=</span>alpha, beta<span class="op">=</span>beta)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        likelihood <span class="op">=</span> pm.Bernoulli(likelihood_name, p<span class="op">=</span>rate, observed<span class="op">=</span>treatment_data)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        efficacy <span class="op">=</span> pm.Deterministic(efficacy_name, <span class="dv">1</span><span class="op">-</span>rate<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>rate)<span class="op">*</span>n_placebo<span class="op">/</span>n_vaccine)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_efficacy_model_with_name(treatment_data, name, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>, n_placebo<span class="op">=</span><span class="dv">1</span>, n_vaccine<span class="op">=</span><span class="dv">1</span>, model<span class="op">=</span>model):</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    rate_name<span class="op">=</span><span class="ss">f"P(</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> treatment | positive)"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    likelihood_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> likelihood"</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    efficacy_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> vaccine efficacy"</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_efficacy_model(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        treatment_data, </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        rate_name<span class="op">=</span>rate_name, </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        likelihood_name<span class="op">=</span>likelihood_name,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        efficacy_name<span class="op">=</span>efficacy_name,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span>beta,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        n_placebo<span class="op">=</span>n_placebo,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        n_vaccine<span class="op">=</span>n_vaccine,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>각 발표된 데이터를 바탕으로 양성 환자들이 백신 접종 여부를 데이터로 만들었습니다.</p>
<div id="aff66a4c" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n_Pfizer_total <span class="op">=</span> <span class="dv">170</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n_Pfizer_vaccine <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>n_Pfizer_placebo <span class="op">=</span> n_Pfizer_total <span class="op">-</span> n_Pfizer_vaccine</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>Pfizer_outcomes <span class="op">=</span> np.concatenate([np.ones(n_Pfizer_vaccine), np.zeros(n_Pfizer_placebo)])</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>n_Moderna_total <span class="op">=</span> <span class="dv">95</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>n_Moderna_vaccine <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>n_Moderna_placebo <span class="op">=</span> n_Moderna_total <span class="op">-</span> n_Moderna_vaccine</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>Moderna_outcomes <span class="op">=</span> np.concatenate([np.ones(n_Moderna_vaccine), np.zeros(n_Moderna_placebo)])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_1_total <span class="op">=</span> <span class="dv">37</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_1_vaccine <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_1_placebo <span class="op">=</span> n_AstraZeneca_1_total <span class="op">-</span> n_AstraZeneca_1_vaccine</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>AstraZeneca_1_outcomes <span class="op">=</span> np.concatenate([np.ones(n_AstraZeneca_1_vaccine), np.zeros(n_AstraZeneca_1_placebo)])</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_2_total <span class="op">=</span> <span class="dv">94</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_2_vaccine <span class="op">=</span> <span class="dv">26</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>n_AstraZeneca_2_placebo <span class="op">=</span> n_AstraZeneca_2_total <span class="op">-</span> n_AstraZeneca_2_vaccine</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>AstraZeneca_2_outcomes <span class="op">=</span> np.concatenate([np.ones(n_AstraZeneca_2_vaccine), np.zeros(n_AstraZeneca_2_placebo)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>4개의 모델을 각각 만들어도 되지만, 한 모델에 4개의 정보를 모두 집어 넣었을 경우 비교하기 위한 forestplot사용이 간단해지기 때문에 같은 모델에 4개의 모델을 집어 넣어 한번에 계산해 보았습니다.</p>
<div id="8d7df9fa" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">"Pfizer"</span>: Pfizer_outcomes, <span class="st">"Moderna"</span>: Moderna_outcomes, <span class="st">"AstraZeneca 1"</span>: AstraZeneca_1_outcomes, <span class="st">"AstraZeneca 2"</span>: AstraZeneca_2_outcomes}</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> pm.Model()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> data.keys():</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> get_efficacy_model_with_name(data[name], name, model<span class="op">=</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>위에서와 똑같이 가장 비싼 연산인 MCMC sampling을 진행했습니다.</p>
<div id="693bde2e" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_trace(model):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> model:</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> pm.sample(draws<span class="op">=</span><span class="dv">5000</span>, step<span class="op">=</span>pm.HamiltonianMC(), start<span class="op">=</span>pm.find_MAP(), progressbar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trace</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> get_trace(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>샘플링한 결과를 아래와 같이 시각화 할 수 있으며 위에서 똑같은 그래프 세트가 4개 나온 것을 볼 수 있습니다.</p>
<div id="3c0af2bb" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    az.plot_trace(trace)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>각각 개별 그래프는 알아보기 어렵기 때문에 각 백신의 효과를 다 모아서 한 그래프로 표기해 보았습니다.</p>
<div id="473219f2" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(trace[<span class="st">'Pfizer vaccine efficacy'</span>], label<span class="op">=</span><span class="st">'Pfizer'</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sns.distplot(trace[<span class="st">'Moderna vaccine efficacy'</span>], hist<span class="op">=</span><span class="va">False</span>, label<span class="op">=</span><span class="st">'Moderna'</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(trace[<span class="st">'AstraZeneca 1 vaccine efficacy'</span>], label<span class="op">=</span><span class="st">'AstraZeneca regimen 1'</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>sns.distplot(trace[<span class="st">'AstraZeneca 2 vaccine efficacy'</span>], hist<span class="op">=</span><span class="va">False</span>, label<span class="op">=</span><span class="st">'AstraZeneca regimen 2'</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Posterior distributions of efficacy of different vaccines"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">"efficacy.png"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>히스토그램 그래프로는 신용구간(credible interval)을 확인하기 다소 어렵기 때문에 백신의 신뢰구간을 모아서 비교할 수 있는 forestplot을 구해보았습니다.</p>
<div id="7688400d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    efficacy_names <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="kw">lambda</span> name: <span class="st">"vaccine efficacy"</span> <span class="kw">in</span> name, trace.varnames))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    pm.forestplot(trace, var_names<span class="op">=</span>efficacy_names)<span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="불확실성의-해석" class="level3">
<h3 class="anchored" data-anchor-id="불확실성의-해석">불확실성의 해석</h3>
<p>그래서 AstraZeneca 1의 백신의 평균만 보면 moderna와 비슷한 효능을 보이는 것 같지만, 불확실성이 훨씬 크기에 Moderna 만큼 좋은가에 대해서는 추가적인 조사가 필요한 것으로 보입니다. 한가지 참고할 만한 부분은 이유는 모르겠지만 AstraZeneca 1방법으로 백신을 놓고 있지는 않는 것으로 알려져 있으며 아마도 당초 설계와 다르기 때문에 그런 것으로 판단됩니다.</p>
</section>
</section>
<section id="백신간의-비교는-어떻게-할까" class="level2">
<h2 class="anchored" data-anchor-id="백신간의-비교는-어떻게-할까">백신간의 비교는 어떻게 할까?</h2>
<p>위에서 진행한 방식을 조금 응용하면 백신 간 예방효과의 우월성을 비교할 수 있습니다. 간단하게 설명하자면 위에서 구하는 efficacy 분포를 서로 빼 보면 됩니다.</p>
<section id="pfizer-vs.-moderna" class="level3">
<h3 class="anchored" data-anchor-id="pfizer-vs.-moderna">Pfizer vs.&nbsp;Moderna</h3>
<p>Pfizer와 Moderna 백신을 비교해보자. 자료는 위에서 사용했던 것을 그대로 사용하고 거의 모든 것은 동일 하지만 마지막에 difference와 ralation을 구해봅니다.</p>
<div id="eaacf028" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_1:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    p_Pfizer <span class="op">=</span> pm.Beta(<span class="st">'p_Pfizer'</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    p_Moderna <span class="op">=</span> pm.Beta(<span class="st">'p_Moderna'</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    like_Pfizer <span class="op">=</span> pm.Bernoulli(<span class="st">'like_Pfizer'</span>, p<span class="op">=</span>p_Pfizer, observed<span class="op">=</span>Pfizer_outcomes)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    like_Moderna <span class="op">=</span> pm.Bernoulli(<span class="st">'like_Moderna'</span>, p<span class="op">=</span>p_Moderna, observed<span class="op">=</span>Moderna_outcomes)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    e_Pfizer <span class="op">=</span> pm.Deterministic(<span class="st">'Pfizer Efficacy'</span>, <span class="dv">1</span> <span class="op">-</span> p_Pfizer<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p_Pfizer))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    e_Moderna <span class="op">=</span> pm.Deterministic(<span class="st">'Moderna Efficacy'</span>, <span class="dv">1</span> <span class="op">-</span> p_Moderna<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p_Moderna))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    pm.Deterministic(<span class="st">'difference'</span>, e_Pfizer<span class="op">-</span>e_Moderna)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    pm.Deterministic(<span class="st">'relation'</span>, (e_Pfizer<span class="op">/</span>e_Moderna)<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    trace_1 <span class="op">=</span> pm.sample(draws<span class="op">=</span><span class="dv">5000</span>, step<span class="op">=</span>pm.Metropolis(), start<span class="op">=</span>pm.find_MAP(), progressbar<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pymc3에서 제공하는 기능을 활용하면 아래와 같은 그래프를 구할 수 있습니다.</p>
<div id="86fa0dc9" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model_1:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> pm.plot_posterior(trace_1, var_names<span class="op">=</span>[<span class="st">'difference'</span>, <span class="st">'relation'</span>], ref_val<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이를 간단히 해석하자면 Pfizer백신이 Moderna백신보다 약간 더 나아 보이기는 합니다.(차이의 평균이 1.1%정도로 Pfizer가 높다고 해석할 수 있다.) 다만, 그 불확실성이 커서 실제로 나은 것인지 아니면 우연히 나은 것인지 판단하기는 어려운 상황입니다.</p>
<div id="2124ff5a" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>diffs_1 <span class="op">=</span> trace_1.get_values(<span class="st">'difference'</span>, burn<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Pfizer가 Moderna보다 나을 확률: </span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span><span class="bu">len</span>(diffs_1[diffs_1<span class="op">&gt;</span><span class="dv">0</span>])<span class="op">*</span><span class="fl">1.0</span><span class="op">/</span><span class="bu">len</span>(diffs_1)<span class="sc">:.2f}</span><span class="ss">% "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="astrazeneca-regime-1-vs.-regime2" class="level3">
<h3 class="anchored" data-anchor-id="astrazeneca-regime-1-vs.-regime2">Astrazeneca Regime 1 Vs. Regime2</h3>
<p>같은 방식으로 AstraZeneca의 용법 1과 용법 2를 비교해 봅니다.</p>
<div id="653ee0ee" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_2:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    p_regimen1 <span class="op">=</span> pm.Beta(<span class="st">'p_regimen1'</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    p_regimen2 <span class="op">=</span> pm.Beta(<span class="st">'p_regimen2'</span>, alpha<span class="op">=</span><span class="dv">1</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    like_regimen1 <span class="op">=</span> pm.Bernoulli(<span class="st">'like_regimen1'</span>, p<span class="op">=</span>p_regimen1, observed<span class="op">=</span>AstraZeneca_1_outcomes)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    like_regimen2 <span class="op">=</span> pm.Bernoulli(<span class="st">'like_regimen2'</span>, p<span class="op">=</span>p_regimen2, observed<span class="op">=</span>AstraZeneca_2_outcomes)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    e_regimen1 <span class="op">=</span> pm.Deterministic(<span class="st">'Regimen1 Efficacy'</span>, <span class="dv">1</span> <span class="op">-</span> p_regimen1<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p_regimen1))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    e_regimen2 <span class="op">=</span> pm.Deterministic(<span class="st">'Regimen2 Efficacy'</span>, <span class="dv">1</span> <span class="op">-</span> p_regimen2<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>p_regimen2))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    pm.Deterministic(<span class="st">'difference'</span>, e_regimen1<span class="op">-</span>e_regimen2)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    pm.Deterministic(<span class="st">'relation'</span>, (e_regimen1<span class="op">/</span>e_regimen2)<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    trace_2 <span class="op">=</span> pm.sample(draws<span class="op">=</span><span class="dv">50000</span>, step<span class="op">=</span>pm.Metropolis(), start<span class="op">=</span>pm.find_MAP(), progressbar<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>결과를 시각화 하면 아래와 같다. 보면 알겠지만, 차이가 0보다 클 확률이 상당히 높은 것을 직관적으로 볼 수 있습니다.</p>
<div id="fd830510" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model_2:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> pm.plot_posterior(trace_2, var_names<span class="op">=</span>[<span class="st">'difference'</span>, <span class="st">'relation'</span>], ref_val<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>용법 1이 용법 2보다 나을 확률이 높음을 알 수 있으며 계산해보면 99%이상 용법 1이 낫다고 볼 수 있습니다. 6%이상 나을 확률도 97% 수준으로 용법 1이 용법 2보다 훨씬 났다고 볼 수 있습니다.</p>
<div id="9b72ee13" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>diffs_2 <span class="op">=</span> trace_2.get_values(<span class="st">'difference'</span>, burn<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Regime1이 Regime2보다 나을 확률: </span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span><span class="bu">len</span>(diffs_2[diffs_2<span class="op">&gt;</span><span class="dv">0</span>])<span class="op">*</span><span class="fl">1.0</span><span class="op">/</span><span class="bu">len</span>(diffs_2)<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Regime1이 Regime2보다 6%이상 나을 확률: </span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span><span class="bu">len</span>(diffs_2[diffs_2<span class="op">&gt;</span><span class="fl">0.06</span>])<span class="op">*</span><span class="fl">1.0</span><span class="op">/</span><span class="bu">len</span>(diffs_2)<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fc0f3114" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.hist(diffs_2, bins<span class="op">=</span><span class="dv">100</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.vlines(<span class="fl">0.06</span>, <span class="dv">0</span>, <span class="dv">6</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Posterior distribution of the difference of the two regimens'</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="백신-효능-측정에-대한-몇가지-추가적인-고찰" class="level2">
<h2 class="anchored" data-anchor-id="백신-효능-측정에-대한-몇가지-추가적인-고찰">백신 효능 측정에 대한 몇가지 추가적인 고찰</h2>
<section id="실험-규모와-상관-없이-양성환자가-너무-적으면-효과가-있는지-알기-어렵다" class="level3">
<h3 class="anchored" data-anchor-id="실험-규모와-상관-없이-양성환자가-너무-적으면-효과가-있는지-알기-어렵다">실험 규모와 상관 없이 양성환자가 너무 적으면 효과가 있는지 알기 어렵다</h3>
<p>백신을 개발하는데 있어서 예방효과측정은 가장 중요한 과정중 하나입니다. 실험 규모가 크면 일반적으로 양성환자가 많이 발생할 것이라고 예상되지만 반드시 필요한 숫자 만큼 나오는 것은 아니라는 것입니다.</p>
<p>예를 들어 지금 박멸되었다고 보고 있는 천연두를 생각해 보죠. 어떤 사람이 새로운 천연두 백신을 개발했다고 해도 우리는 그 백신이 효과가 있는지 알기 어렵습니다. 왜냐하면 양성환자가 나오지 않기 때문에 위와 같은 테스트를 할 수 없기 때문입니다.</p>
</section>
<section id="실험-내에서-양성-환자가-많으면-많을-수록-정확한-값을-알-수-있다" class="level3">
<h3 class="anchored" data-anchor-id="실험-내에서-양성-환자가-많으면-많을-수록-정확한-값을-알-수-있다">실험 내에서 양성 환자가 많으면 많을 수록 정확한 값을 알 수 있다</h3>
<p>많은 양성환자가 더 백신의 효능을 올려주는 것은 아니지만 백신의 효능을 조금 더 정확하게 알 수 있습니다.</p>
<p>간단하게 생각해 보면 10명 중 1명이 양성인 경우는 운이 좋아서 10%인 건인지 아니면 운이 나빠서 10%인 것인지 알기가 어렵습니다. 한명만 추가 되거나 줄어도 비율이 20%에서 0%까지 흔들리기 때문입니다.</p>
<p>하지만 100명 중 10명이라고 한다면 한명이 더 생기거나 덜 생기면 9%~11% 이기 때문에 조금더 정확하다고 판단할 수 있습니다.</p>
<p>그렇기 때문에 많이 유행하고 있는 국가에서 실험을 해야 백신의 효과를 상대적으로 적은 실험을 통해서도 알 수 있게 됩니다.</p>
</section>
<section id="반드시-접종-vs-비접종자의-숫자가-동수일-필요는-없다" class="level3">
<h3 class="anchored" data-anchor-id="반드시-접종-vs-비접종자의-숫자가-동수일-필요는-없다">반드시 접종 vs 비접종자의 숫자가 동수일 필요는 없다</h3>
<p>많은 경우 실험을 할 때 양쪽의 숫자를 동수로 두고 진행하는 경향이 있는 것 같습니다. 하지만 반드시 동수로 진행 할 필요는 없으며 상황에 맞게 진행하되 나중에 결과 해석에서 조정할 수 있습니다. 다만 여러가지 알 수 없는 변수에 대한 대응 차원에서 단순하게 동수로 가는 경향이 강한 것으로 생각됩니다.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="JunDamin/recipes4ds" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
<script src="https://giscus.app/client.js" data-repo="JunDamin/recipes4ds" data-repo-id="R_kgDOIAXuPw" data-category="General" data-category-id="DIC_kwDOIAXuP84CdD73" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->




</body></html>